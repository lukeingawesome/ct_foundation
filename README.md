# iRail Chest FM Docker Environment

A Docker-based development environment for chest foundation model training with automatic user permission handling and CUDA support.

## Features

- üê≥ **Automatic User Setup**: Automatically detects and uses your host UID/GID for seamless file permissions
- üîß **Permission Handling**: Built-in permission fixes ensure you can edit all files in the container
- üöÄ **GPU Support**: CUDA 12.4 with cuDNN for GPU-accelerated training
- üì¶ **One-Command Setup**: Simple Makefile targets for common operations
- üîó **Volume Mounting**: Pre-configured data and model directories

## Quick Start

```bash
git clone https://github.com/lukeingawesome/ct_foundation.git
cd ct_foundation

# Build and start the environment (automatically detects your user settings)
make build
make up
```

## Available Commands

| Command | Description |
|---------|-------------|
| `make help` | Show all available commands with current user settings |
| `make build` | Build the Docker image with your user settings |
| `make up` | Start the container |
| `make down` | Stop and remove the container |
| `make restart` | Restart the container |
| `make shell` | Open a shell in the running container |
| `make env` | Create .env file with current user values |
| `make clean` | Remove container and image completely |
| `make show-env` | Display current environment variables |

## Usage

### 1. Build the Environment
```bash
make build
```
This automatically detects your UID, GID, and username for seamless file permissions.

### 2. Start the Container
```bash
make up
```

### 3. Access the Container
```bash
make shell
```

### 4. Work with Your Code
All files in the project directory are automatically owned by your user with full edit permissions.

## Automatic User Detection

The Makefile automatically detects and uses:
- `UID`: Your user ID for file ownership
- `GID`: Your group ID for file ownership  
- `USR`: Your username
- `PROJECT`: Set to `hanbin_fm` (can be customized)

No manual `.env` file configuration needed! The system automatically handles user permissions.

## Environment Variables

If you need to customize settings, create a `.env` file:

```bash
make env  # Creates .env with detected values
```

This generates:
```env
# Docker environment variables
# Generated by 'make env' - modify as needed

# User/Group IDs (automatically detected)
UID=1000
GID=1000
USR=your_username

# Project configuration
PROJECT=hanbin_fm
PROJECT_ROOT=/opt/project
```

## Volume Mounts

| Host Path | Container Path | Purpose |
|-----------|----------------|---------|
| `.` (current directory) | `/opt/project` | Project workspace |
| `/BARO_Cluster/data/data` | `/data2` | Research datasets (read-only) |
| `/home/data` | `/data` | General data storage |
| `/home/model` | `/model` | Model storage |

## Permission Handling

The container automatically:
- ‚úÖ Fixes file ownership to match your user
- ‚úÖ Sets proper read/write permissions
- ‚úÖ Ensures directory execute permissions
- ‚úÖ Runs permission fixes on container startup

No more "permission denied" errors when editing files!

## Troubleshooting

### Check Current Settings
```bash
make show-env
```

### Check Container Status
```bash
docker ps -a
```

### Check GPU Access
```bash
make shell
nvidia-smi
```

### Rebuild Everything
```bash
make clean
make build
make up
```

### Permission Issues
If you encounter permission issues, the container automatically fixes them on startup. You can also manually run:
```bash
make restart
```

## Advanced Usage

### Manual Docker Commands (if needed)
The Makefile handles everything, but if you need manual control:

```bash
# With automatic user detection
export UID=$(id -u) GID=$(id -g) USR=$(whoami)
docker-compose up -d
```

### Custom Project Name
Edit the `PROJECT` variable in the Makefile or set it via environment:
```bash
PROJECT=my_custom_name make build
```
